<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVE Online Buyback Calculator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 100%; height: 200px; }
        button { margin: 10px 0; padding: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        #results { margin-top: 20px; }
        .error { color: red; }
        #loading { display: none; color: blue; font-weight: bold; margin-left: 10px; display: inline-block; }
        .total { font-size: 1.1em; font-weight: bold; margin: 10px 0; padding: 8px; background-color: #f8f9fa; border-left: 4px solid #1a5fb4; }
        .info { font-size: 0.9em; color: #555; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>EVE Online Buyback Tool</h1>
    <p class="info">Paste your inventory items below in the format: <code>Item Name Quantity</code> (one per line). Duplicates are summed.</p>
    <p class="info"><strong>Tax:</strong> 10% on Jita max buy if ISK per m³ ≥ 2500, otherwise 20%.</p>
    <textarea id="input" placeholder="Microwave L 13&#10;Valkyrie I 3&#10;..."></textarea>
    <br>
    <button onclick="calculate()">Calculate</button>
    <p id="loading" style="display: none;">Loading 0%...</p>
    <div id="results"></div>

    <script>
        // -------------------------------------------------
        // Data structures
        // -------------------------------------------------
        const itemMap        = new Map();   // name → {typeId, volume, groupId, categoryId}
        const nameToInfo     = new Map();
        const materialsMap   = new Map();   // typeId → array of materials
        const groupMap       = new Map();
        const categoryMap    = new Map();
        const skinMap        = new Map();   // skinID → {typeId, name}
        let loaded = false;

        // -------------------------------------------------
        // Helper: load JSONL
        // -------------------------------------------------
        async function loadJsonl(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Fetch failed for ${url}: ${res.status}`);
            const text = await res.text();
            return text.trim().split('\n')
                       .filter(l => l.trim())
                       .map(l => JSON.parse(l));
        }

        // -------------------------------------------------
        // Load all static data (safe handling of skinMaterials)
        // -------------------------------------------------
        async function loadData(updateProgress) {
            if (loaded) return;
            console.log('Starting data load...');
            try {
                const base = 'https://raw.githubusercontent.com/The-Suit7/cepheus/main/eve-data/';
                const totalSteps = 11;
                let step = 0;

                // 1. categories
                updateProgress(step++, totalSteps);
                const cats = await loadJsonl(base + 'categories.jsonl');
                cats.forEach(r => categoryMap.set(r['_key'], r['name']['en']));

                // 2. groups
                updateProgress(step++, totalSteps);
                const grps = await loadJsonl(base + 'groups.jsonl');
                grps.forEach(r => groupMap.set(r['_key'], {name: r['name']['en'], categoryId: r['categoryID']}));

                // 3. typeMaterials
                updateProgress(step++, totalSteps);
                const tmats = await loadJsonl(base + 'typeMaterials.jsonl');
                tmats.forEach(r => {
                    if (r['materials']) {
                        materialsMap.set(r['_key'],
                            r['materials'].map(m => ({materialId: m['materialTypeID'], quantity: m['quantity']})));
                    }
                });

                // 4-9. types1 … types6
                const types = [];
                for (let i = 1; i <= 6; i++) {
                    updateProgress(step++, totalSteps);
                    const part = await loadJsonl(base + `types${i}.jsonl`);
                    types.push(...part);
                }

                // 10. skins.jsonl
                updateProgress(step++, totalSteps);
                const skins = await loadJsonl(base + 'skins.jsonl');
                skins.forEach(r => {
                    const name = r['skinName']?.['en'] || r['name']?.['en'] || 'Unknown Skin';
                    skinMap.set(r['_key'], {typeId: r['typeID'], name});
                });

                // 11. skinMaterials.jsonl – SAFE handling
                updateProgress(step++, totalSteps);
                const skinMats = await loadJsonl(base + 'skinMaterials.jsonl');
                skinMats.forEach(r => {
                    if (r['materials'] && Array.isArray(r['materials'])) {
                        materialsMap.set(r['_key'],
                            r['materials'].map(m => ({materialId: m['materialTypeID'], quantity: m['quantity']})));
                    }
                });

                // Build main item map (regular items)
                types.forEach(row => {
                    if (row['published'] && row['marketGroupID']) {
                        const name = row['name']['en'];
                        const vol  = row['volume'] || 0;
                        if (vol === 0) return;
                        const gInfo = groupMap.get(row['groupID']) || {categoryId: 0};
                        itemMap.set(name, {
                            typeId: row['_key'],
                            volume: vol,
                            groupId: row['groupID'],
                            categoryId: gInfo.categoryId
                        });
                    }
                });

                // Add skins to item map
                skinMap.forEach((skin, skinId) => {
                    itemMap.set(skin.name, {
                        typeId: skin.typeId,
                        volume: 0.01,
                        groupId: 1950,
                        categoryId: 91
                    });
                });

                console.log('Item map built (incl. skins):', itemMap.size);
                loaded = true;
                console.log('Data load complete.');
            } catch (e) {
                console.error('Data load error:', e);
                alert('Failed to load data: ' + e.message + '. Check console for details.');
            }
        }

        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100);
            document.getElementById('loading').innerHTML = `Loading ${pct}%...`;
        }

        // -------------------------------------------------
        // Main calculation
        // -------------------------------------------------
        async function calculate() {
            document.getElementById('loading').style.display = 'inline-block';
            document.getElementById('loading').innerHTML = 'Loading 0%...';
            await loadData(updateProgress);
            document.getElementById('loading').innerHTML = 'Processing results...';

            const text = document.getElementById('input').value;
            const lines = text.trim().split('\n').filter(l => l.trim());
            const itemTotals = new Map();

            for (let line of lines) {
                const parts = line.trim().split(/\s+/);
                if (parts.length < 2) continue;
                const qtyStr = parts.pop();
                const qty = parseInt(qtyStr);
                if (isNaN(qty) || qty <= 0) continue;
                const name = parts.join(' ');
                itemTotals.set(name, (itemTotals.get(name) || 0) + qty);
            }

            const items = Array.from(itemTotals, ([name, qty]) => ({name, qty}));
            if (items.length === 0) {
                document.getElementById('results').innerHTML = '<p>No valid items parsed.</p>';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            const allTypeIds = new Set();
            const allMaterialIds = new Set();

            items.forEach(item => {
                const info = itemMap.get(item.name);
                if (!info) {
                    nameToInfo.set(item.name, {error: 'Item not found'});
                } else {
                    nameToInfo.set(item.name, {
                        typeId: info.typeId,
                        volume: info.volume,
                        groupId: info.groupId,
                        categoryId: info.categoryId
                    });
                    allTypeIds.add(info.typeId);
                    const mats = materialsMap.get(info.typeId) || [];
                    mats.forEach(m => allMaterialIds.add(m.materialId));
                }
            });

            const typeIdsToFetch = [...new Set([...allTypeIds, ...allMaterialIds])];
            let prices = {};
            if (typeIdsToFetch.length) {
                try {
                    const agg = `https://market.fuzzwork.co.uk/aggregates/?region=30000142&types=${typeIdsToFetch.join(',')}`;
                    const res = await fetch(agg);
                    if (res.ok) prices = await res.json();
                } catch (e) { console.error('Price fetch error:', e); }
            }

            let totalMaxBuy = 0;
            let totalBuyback = 0;
            const rows = [];

            for (let item of items) {
                const info = nameToInfo.get(item.name);
                let tr = `<tr><td>${item.name}</td><td>${item.qty}</td>`;

                if (info.error) {
                    tr += `<td colspan="4" class="error">Error: ${info.error}</td></tr>`;
                    rows.push(tr);
                    continue;
                }

                const maxBuy = parseFloat(prices[info.typeId]?.buy?.max || '0');
                const iskM3   = maxBuy / info.volume;

                const taxRate = iskM3 >= 2500 ? 10 : 20;
                const offerPer = maxBuy * (1 - taxRate/100);
                const offerTot = offerPer * item.qty;

                totalMaxBuy   += maxBuy * item.qty;
                totalBuyback  += offerTot;

                tr += `<td>${maxBuy.toLocaleString()}</td>
                       <td>${Math.round(iskM3)}</td>
                       <td>${taxRate}%</td>
                       <td>${Math.round(offerTot).toLocaleString()}</td></tr>`;
                rows.push(tr);
            }

            const html = `
                <div class="total">Buyback Offer: ${Math.round(totalBuyback).toLocaleString()} ISK</div>
                <table>
                    <tr><th>Item Name</th><th>Total Qty</th><th>Max Jita Buy (ISK)</th><th>ISK per m³</th><th>Corp Tax %</th><th>Buyback Offer (ISK)</th></tr>
                    ${rows.join('')}
                </table>`;

            document.getElementById('results').innerHTML = html;
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
